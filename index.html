<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Response Hub | Admin</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- SheetJS for Excel Support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'global-response-hub';
        let db, auth;

        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                const config = JSON.parse(__firebase_config);
                if (!firebase.apps.length) {
                    const app = firebase.initializeApp(config);
                    db = firebase.firestore(app);
                    auth = firebase.auth(app);
                } else {
                    db = firebase.firestore();
                    auth = firebase.auth();
                }
            }
        } catch (e) { console.error("Firebase Init Error:", e); }

        const Icons = {
            Search: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>,
            Plus: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"/></svg>,
            Trash: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>,
            Lock: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>,
            Upload: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>,
            Heart: () => <svg className="w-3 h-3 fill-rose-500" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");
            const [password, setPassword] = useState("");
            const [showForm, setShowForm] = useState(false);
            const [form, setForm] = useState({ category: "", scenario: "", message: "" });
            const [toast, setToast] = useState(null);
            
            const fileInputRef = useRef(null);

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 4000);
            };

            useEffect(() => {
                if (!auth) { setLoading(false); return; }
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) { console.error("Auth failed:", e); }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged(u => {
                    setUser(u);
                    if (!u) setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!isAuthenticated || !db || !user) return;
                setLoading(true);
                const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses');
                const unsubscribe = colRef.onSnapshot(snapshot => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setData(items);
                    setLoading(false);
                }, (err) => {
                    console.error("Snapshot Error:", err);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [isAuthenticated, user]);

            const handleLogin = (e) => {
                e.preventDefault();
                if (password === "user123") setIsAuthenticated(true);
                else showToast("Wrong Password");
            };

            const toggleAdmin = () => {
                if (isAdmin) setIsAdmin(false);
                else {
                    const pw = prompt("Admin Key:");
                    if (pw === "admin123") setIsAdmin(true);
                    else if (pw) showToast("Invalid Key");
                }
            };

            const bulkUpload = async (items) => {
                if (!items.length) {
                    showToast("No valid data found in file");
                    return;
                }
                
                setIsSaving(true);
                showToast(`Importing ${items.length} items. Please wait...`);

                try {
                    const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses');
                    
                    // Firestore batches have a limit of 500. We'll use 450 to be safe.
                    const chunkSize = 450;
                    for (let i = 0; i < items.length; i += chunkSize) {
                        const batch = db.batch();
                        const chunk = items.slice(i, i + chunkSize);
                        
                        chunk.forEach(item => {
                            const newDocRef = colRef.doc();
                            batch.set(newDocRef, {
                                ...item,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                authorId: user.uid
                            });
                        });
                        
                        await batch.commit();
                        console.log(`Uploaded chunk ${Math.floor(i/chunkSize) + 1}`);
                    }

                    showToast(`Successfully imported ${items.length} responses`);
                } catch (err) {
                    console.error("Bulk Upload Error:", err);
                    showToast(`Import Error: ${err.message || 'Check database permissions'}`);
                } finally {
                    setIsSaving(false);
                    if (fileInputRef.current) fileInputRef.current.value = "";
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file || !isAdmin) return;

                const reader = new FileReader();

                if (file.name.endsWith('.json')) {
                    reader.onload = async (evt) => {
                        try {
                            const imported = JSON.parse(evt.target.result);
                            if (Array.isArray(imported)) {
                                await bulkUpload(imported);
                            } else {
                                showToast("JSON must be an array of objects");
                            }
                        } catch (err) { showToast("Invalid JSON file format"); }
                    };
                    reader.readAsText(file);
                } else {
                    reader.onload = async (evt) => {
                        try {
                            const bstr = evt.target.result;
                            const wb = XLSX.read(bstr, { type: 'binary' });
                            let imported = [];
                            
                            wb.SheetNames.forEach((sheetName) => {
                                const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                                const entries = jsonData.map(row => {
                                    // Intelligent column mapping
                                    const keys = Object.keys(row);
                                    const findKey = (search) => keys.find(k => k.toLowerCase().includes(search.toLowerCase()));
                                    
                                    const scenarioKey = findKey('scenario') || findKey('title') || findKey('subject') || keys[0];
                                    const messageKey = findKey('message') || findKey('body') || findKey('response') || keys[1];
                                    const catKey = findKey('category') || findKey('group');
                                    
                                    return {
                                        scenario: String(row[scenarioKey] || "Untitled"),
                                        message: String(row[messageKey] || ""),
                                        category: catKey ? String(row[catKey]) : sheetName
                                    };
                                }).filter(i => i.message && i.message.trim() !== "");
                                
                                imported = [...imported, ...entries];
                            });
                            
                            await bulkUpload(imported);
                        } catch (err) { 
                            console.error("Excel Read Error:", err);
                            showToast("Error reading Excel file"); 
                        }
                    };
                    reader.readAsBinaryString(file);
                }
            };

            const handleSave = async (e) => {
                e.preventDefault();
                if (!isAdmin || !db || isSaving) return;
                setIsSaving(true);
                try {
                    const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses');
                    await colRef.add({
                        ...form,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        authorId: user.uid
                    });
                    setForm({ category: "", scenario: "", message: "" });
                    setShowForm(false);
                    showToast("Entry saved to cloud");
                } catch (err) {
                    showToast("Save Failed");
                } finally {
                    setIsSaving(false);
                }
            };

            const handleDelete = async (id) => {
                if (!isAdmin || !confirm("Delete this entry?")) return;
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').doc(id).delete();
                    showToast("Deleted");
                } catch (e) { showToast("Delete Failed"); }
            };

            const filteredData = useMemo(() => {
                return data.filter(i => 
                    i.scenario?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    i.message?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    i.category?.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [data, searchTerm]);

            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-900 p-6">
                        <div className="w-full max-w-sm bg-white p-8 rounded-3xl shadow-2xl space-y-6">
                            <div className="text-center">
                                <h2 className="text-2xl font-extrabold text-slate-800">Welcome Back</h2>
                                <p className="text-slate-400 text-sm mt-1">Response Library Access</p>
                            </div>
                            <form onSubmit={handleLogin} className="space-y-4">
                                <input 
                                    type="password" 
                                    placeholder="Enter Password" 
                                    className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 text-center"
                                    value={password}
                                    onChange={e => setPassword(e.target.value)}
                                    autoFocus
                                />
                                <button className="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl hover:bg-indigo-700 transition-all">Unlock Hub</button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-20">
                    <nav className="fixed top-0 w-full z-50 glass h-16 flex items-center px-6">
                        <div className="max-w-7xl mx-auto w-full flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-black text-xs">RH</div>
                                <span className="font-bold text-slate-800 hidden sm:block">Response Hub</span>
                            </div>

                            <div className="flex items-center gap-2">
                                {isAdmin && (
                                    <>
                                        <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".xlsx,.xls,.json" className="hidden" />
                                        <button 
                                            onClick={() => fileInputRef.current.click()}
                                            disabled={isSaving}
                                            className="p-2.5 text-slate-500 hover:bg-slate-100 rounded-xl transition-colors disabled:opacity-30"
                                            title="Import File"
                                        >
                                            <Icons.Upload />
                                        </button>
                                        <button 
                                            disabled={isSaving}
                                            onClick={() => setShowForm(!showForm)} 
                                            className="bg-slate-900 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 disabled:opacity-50"
                                        >
                                            <Icons.Plus /> {showForm ? "Close" : "New Entry"}
                                        </button>
                                    </>
                                )}
                                <button onClick={toggleAdmin} className={`p-2.5 rounded-xl transition-colors ${isAdmin ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400 hover:bg-slate-100'}`}>
                                    <Icons.Lock />
                                </button>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-5xl mx-auto px-6 pt-24">
                        <div className="mb-10 relative">
                            <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search /></div>
                            <input 
                                type="text" 
                                placeholder="Search by title, category, or keywords..." 
                                className="w-full pl-12 pr-6 py-4 bg-white border border-slate-200 rounded-2xl shadow-sm outline-none focus:ring-4 focus:ring-indigo-50 transition-all"
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                            />
                        </div>

                        {showForm && (
                            <form onSubmit={handleSave} className="bg-white p-6 rounded-3xl border-2 border-indigo-100 mb-10 shadow-lg space-y-4">
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <input placeholder="Category (e.g. Greeting)" className="p-3 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" value={form.category} onChange={e => setForm({...form, category: e.target.value})} required />
                                    <input placeholder="Scenario (e.g. Late Arrival)" className="p-3 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" value={form.scenario} onChange={e => setForm({...form, scenario: e.target.value})} required />
                                </div>
                                <textarea placeholder="Paste message here..." className="w-full p-4 bg-slate-50 rounded-xl h-32 outline-none focus:ring-2 focus:ring-indigo-500" value={form.message} onChange={e => setForm({...form, message: e.target.value})} required />
                                <button disabled={isSaving} className="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 disabled:bg-slate-300">
                                    {isSaving ? "Syncing..." : "Publish to Database"}
                                </button>
                            </form>
                        )}

                        {loading ? (
                            <div className="flex flex-col items-center py-20">
                                <div className="loader"></div>
                                <p className="text-xs font-bold text-slate-400 mt-4 uppercase tracking-widest">Syncing with Cloud...</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {filteredData.length > 0 ? filteredData.map(item => (
                                    <div 
                                        key={item.id} 
                                        onClick={() => { 
                                            document.execCommand('copy') || navigator.clipboard.writeText(item.message); 
                                            showToast("Copied"); 
                                        }}
                                        className="group bg-white p-6 rounded-3xl border border-slate-100 shadow-sm hover:shadow-md hover:border-indigo-100 transition-all cursor-pointer relative active:scale-[0.98]"
                                    >
                                        <div className="flex justify-between items-start mb-3">
                                            <span className="text-[10px] font-black uppercase tracking-widest text-indigo-500 bg-indigo-50 px-2 py-1 rounded-md">
                                                {item.category || "General"}
                                            </span>
                                            {isAdmin && (
                                                <button onClick={(e) => { e.stopPropagation(); handleDelete(item.id); }} className="p-1 text-slate-200 hover:text-rose-500 transition-colors">
                                                    <Icons.Trash />
                                                </button>
                                            )}
                                        </div>
                                        <h3 className="font-bold text-slate-800 mb-2 group-hover:text-indigo-600 transition-colors">{item.scenario}</h3>
                                        <p className="text-slate-500 text-sm whitespace-pre-wrap line-clamp-6">{item.message}</p>
                                    </div>
                                )) : (
                                    <div className="col-span-full py-20 text-center border-2 border-dashed border-slate-200 rounded-[2.5rem] flex flex-col items-center justify-center space-y-4">
                                        <p className="text-slate-400 text-sm">Library is empty.</p>
                                        {isAdmin && (
                                            <div className="flex gap-2">
                                                <button onClick={() => setShowForm(true)} className="px-5 py-2.5 bg-indigo-600 text-white rounded-xl text-xs font-bold flex items-center gap-2"><Icons.Plus /> New Entry</button>
                                                <button onClick={() => fileInputRef.current.click()} className="px-5 py-2.5 bg-white border border-slate-200 text-slate-600 rounded-xl text-xs font-bold flex items-center gap-2"><Icons.Upload /> Import Excel</button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {toast && (
                        <div className="fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest rounded-full shadow-2xl z-[100] animate-in slide-in-from-bottom-4 duration-300">
                            {toast}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
