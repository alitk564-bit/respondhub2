<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Response Hub - Cloud Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCkWkxeidV9x8BvNGD-jcmL44ha4vHHlf8",
            authDomain: "respondhub-c4641.firebaseapp.com",
            projectId: "respondhub-c4641",
            storageBucket: "respondhub-c4641.firebasestorage.app",
            messagingSenderId: "682357623707",
            appId: "1:682357623707:web:e256f3ab48219bbfdfaf3e",
            measurementId: "G-TLKTF1JK6N"
        };

        // Global Initialization
        const app = !firebase.apps.length ? firebase.initializeApp(firebaseConfig) : firebase.app();
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "respondhub-c4641";

        const App = () => {
            const [user, setUser] = useState(null);
            const [authError, setAuthError] = useState(false);
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isAdmin, setIsAdmin] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");
            const [showForm, setShowForm] = useState(false);
            const [form, setForm] = useState({ category: "", scenario: "", message: "", section: "" });
            const [editingId, setEditingId] = useState(null);
            const [toast, setToast] = useState(null);

            // --- AUTHENTICATION (Rule 3 Fix) ---
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        // Attempt Anonymous Auth
                        await auth.signInAnonymously();
                    } catch (error) {
                        console.error("Auth failed:", error);
                        if (error.code === 'auth/configuration-not-found') {
                            setAuthError(true);
                            setToast({ 
                                msg: "Configuration Required: Enable 'Anonymous' sign-in in Firebase Console", 
                                type: "error" 
                            });
                        } else {
                            setToast({ msg: "Cloud Connection Error", type: "error" });
                        }
                        // Even if auth fails, we stop loading to show the UI
                        setLoading(false);
                    }
                };

                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    if (u) setAuthError(false);
                });

                initAuth();
                return () => unsubscribe();
            }, []);

            // --- DATA FETCHING (Rules 1 & 3) ---
            useEffect(() => {
                // If auth is broken, we can't query Firestore safely if rules enforce auth
                if (!user && !authError) return;

                const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses');
                
                const unsubscribe = collectionRef.onSnapshot((snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setData(items);
                    setLoading(false);
                }, (err) => {
                    console.error("Firestore Error:", err);
                    // If authError is true, this is expected
                    if (!authError) {
                        setToast({ msg: "Database Access Denied. Check Security Rules.", type: "error" });
                    }
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user, authError]);

            const showToast = (msg, type = "success") => {
                setToast({ msg, type });
                if (type !== "error") {
                    setTimeout(() => setToast(null), 3000);
                }
            };

            const toggleAdmin = () => {
                if (isAdmin) { setIsAdmin(false); return; }
                const pw = prompt("Admin Password:");
                if (pw === "ALM989$100%") setIsAdmin(true);
                else showToast("Wrong password", "error");
            };

            const handleSave = async (e) => {
                e.preventDefault();
                if (!isAdmin) return;
                if (!user) {
                    showToast("Cannot save: Authentication not configured.", "error");
                    return;
                }

                const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses');
                try {
                    if (editingId) {
                        await colRef.doc(editingId).update(form);
                        showToast("Updated Cloud");
                    } else {
                        await colRef.add({ 
                            ...form, 
                            timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                        });
                        showToast("Saved to Cloud");
                    }
                    setForm({ category: "", scenario: "", message: "", section: "" });
                    setShowForm(false);
                    setEditingId(null);
                } catch (err) {
                    showToast("Cloud Save Error", "error");
                }
            };

            const handleDelete = async (id) => {
                if (!isAdmin || !confirm("Delete forever?")) return;
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').doc(id).delete();
                    showToast("Deleted");
                } catch (err) {
                    showToast("Delete Error", "error");
                }
            };

            const filteredData = data.filter(i => 
                (i.scenario || "").toLowerCase().includes(searchTerm.toLowerCase()) || 
                (i.message || "").toLowerCase().includes(searchTerm.toLowerCase()) ||
                (i.category || "").toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="min-h-screen pb-20">
                    <header className="bg-white border-b sticky top-0 z-40 px-6 py-4 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-white font-black shadow-lg ${user ? 'bg-indigo-600' : 'bg-red-500'}`}>
                                {user ? 'RH' : '!'}
                            </div>
                            <div>
                                <h1 className="font-extrabold text-slate-900 tracking-tight text-lg">Response Hub</h1>
                                <p className={`text-[10px] font-bold uppercase tracking-tighter ${authError ? 'text-red-500' : 'text-slate-400'}`}>
                                    {user ? `Cloud Active: ${user.uid.slice(0, 8)}` : (authError ? 'Auth Config Error' : 'Connecting...')}
                                </p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={toggleAdmin} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${isAdmin ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-500'}`}>
                                {isAdmin ? 'ADMIN ACTIVE' : 'ADMIN LOGIN'}
                            </button>
                            {isAdmin && (
                                <button onClick={() => { setShowForm(!showForm); setEditingId(null); }} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-indigo-200 shadow-lg hover:bg-indigo-700 transition-colors">
                                    {showForm ? 'CLOSE' : 'ADD NEW'}
                                </button>
                            )}
                        </div>
                    </header>

                    {authError && (
                        <div className="max-w-6xl mx-auto px-6 mt-4">
                            <div className="bg-red-50 border border-red-100 rounded-xl p-4 flex items-start gap-3">
                                <div className="text-red-500 mt-0.5">⚠️</div>
                                <div>
                                    <p className="text-xs font-bold text-red-700 uppercase tracking-wide">Firebase Setup Required</p>
                                    <p className="text-xs text-red-600 mt-1">
                                        Anonymous Authentication is disabled. Go to <b>Firebase Console > Authentication > Sign-in method</b> and enable <b>Anonymous</b> to sync data.
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}

                    <main className="max-w-6xl mx-auto p-6">
                        <div className="mb-8">
                            <input 
                                type="text" 
                                placeholder="Search all responses..." 
                                className="w-full bg-white border border-slate-200 p-5 rounded-2xl shadow-sm outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-lg"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>

                        {showForm && (
                            <div className="bg-white p-6 rounded-2xl border border-indigo-100 shadow-xl mb-10">
                                <form onSubmit={handleSave} className="space-y-4">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <input placeholder="Category (e.g. Sales)" className="bg-slate-50 p-3 rounded-lg border w-full outline-none focus:bg-white" value={form.category} onChange={e => setForm({...form, category: e.target.value})} required />
                                        <input placeholder="Section (Optional)" className="bg-slate-50 p-3 rounded-lg border w-full outline-none focus:bg-white" value={form.section} onChange={e => setForm({...form, section: e.target.value})} />
                                        <input placeholder="Scenario Name" className="bg-slate-50 p-3 rounded-lg border w-full outline-none focus:bg-white" value={form.scenario} onChange={e => setForm({...form, scenario: e.target.value})} required />
                                    </div>
                                    <textarea placeholder="The message content..." className="bg-slate-50 p-3 rounded-lg border w-full h-40 outline-none focus:bg-white resize-none" value={form.message} onChange={e => setForm({...form, message: e.target.value})} required />
                                    <button className="w-full bg-indigo-600 text-white py-4 rounded-xl font-black uppercase tracking-widest shadow-lg hover:bg-indigo-700 transition-all">
                                        {editingId ? 'Update Record' : 'Save to Cloud'}
                                    </button>
                                </form>
                            </div>
                        )}

                        {loading ? (
                            <div className="flex flex-col items-center py-24">
                                <div className="loader mb-4"></div>
                                <span className="text-slate-400 font-bold text-xs uppercase tracking-widest">Connecting to Cloud...</span>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {filteredData.length === 0 && (
                                    <div className="col-span-full py-24 text-center bg-white rounded-3xl border border-dashed border-slate-200">
                                        <p className="text-slate-400 font-medium">No cloud entries found.</p>
                                        {isAdmin && <button onClick={() => setShowForm(true)} className="mt-2 text-indigo-600 font-bold text-sm">Create first entry</button>}
                                    </div>
                                )}
                                {filteredData.map(item => (
                                    <div 
                                        key={item.id} 
                                        onClick={() => { navigator.clipboard.writeText(item.message); showToast("Copied to clipboard!"); }}
                                        className="group bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer relative overflow-hidden h-full flex flex-col"
                                    >
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="flex flex-col gap-1">
                                                <span className="bg-indigo-50 text-indigo-600 text-[9px] font-black px-2 py-0.5 rounded uppercase tracking-widest w-fit">{item.category}</span>
                                                {item.section && <span className="text-[9px] font-bold text-slate-300 uppercase tracking-widest ml-1">{item.section}</span>}
                                            </div>
                                            {isAdmin && (
                                                <div className="flex gap-2">
                                                    <button onClick={(e) => { e.stopPropagation(); setEditingId(item.id); setForm(item); setShowForm(true); }} className="text-[10px] font-bold text-slate-400 hover:text-indigo-600 uppercase">Edit</button>
                                                    <button onClick={(e) => { e.stopPropagation(); handleDelete(item.id); }} className="text-[10px] font-bold text-slate-400 hover:text-red-600 uppercase">Del</button>
                                                </div>
                                            )}
                                        </div>
                                        <h3 className="font-bold text-slate-800 mb-2 text-base leading-tight">{item.scenario}</h3>
                                        <p className="text-sm text-slate-500 line-clamp-5 leading-relaxed whitespace-pre-wrap flex-grow">{item.message}</p>
                                        <div className="mt-6 pt-4 border-t border-slate-50 text-[9px] font-black text-slate-300 uppercase tracking-widest flex justify-between items-center group-hover:text-indigo-400 transition-colors">
                                            <span>Click to Copy</span>
                                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path></svg>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {toast && (
                        <div className={`fixed bottom-6 left-1/2 -translate-x-1/2 px-8 py-4 rounded-2xl text-white text-[10px] font-black tracking-widest shadow-2xl z-50 flex items-center gap-3 animate-in ${toast.type === 'error' ? 'bg-red-600' : 'bg-slate-900'}`}>
                            {toast.msg.toUpperCase()}
                            {toast.type === 'error' && <button onClick={() => setToast(null)} className="ml-2 hover:opacity-50 text-xs">✕</button>}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
