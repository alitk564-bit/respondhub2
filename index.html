<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Response Hub</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Segoe UI', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'card': '0 0 0 1px rgba(0,0,0,0.03), 0 2px 8px rgba(0,0,0,0.04)',
                    }
                }
            }
        }
    </script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #f8fafc; -webkit-font-smoothing: antialiased; }
        .glass-panel { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { 
            Upload, Search, Check, Trash2, FileText, 
            Plus, Edit3, Download, Copy, LayoutGrid, X, Save, Heart, Lock, Unlock
        } = lucide;

        // Firebase Configuration from Environment
        const firebaseConfig = JSON.parse(__firebase_config);
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const THEMES = [
            { id: 'blue', bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700' },
            { id: 'violet', bg: 'bg-violet-50', border: 'border-violet-200', text: 'text-violet-700' },
            { id: 'emerald', bg: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-emerald-700' },
            { id: 'rose', bg: 'bg-rose-50', border: 'border-rose-200', text: 'text-rose-700' },
            { id: 'amber', bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-700' },
            { id: 'cyan', bg: 'bg-cyan-50', border: 'border-cyan-200', text: 'text-cyan-700' },
            { id: 'orange', bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-700' }
        ];

        const App = () => {
            const [isAdmin, setIsAdmin] = useState(false);
            const [user, setUser] = useState(null);
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState("");
            const [activeCategory, setActiveCategory] = useState("All");
            const [toast, setToast] = useState({ show: false, message: "" });
            const [showForm, setShowForm] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [formEntry, setFormEntry] = useState({ scenario: "", message: "", category: "", section: "" });
            
            const fileInputRef = useRef(null);

            // Authentication Initialization
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (err) {
                        console.error("Auth error:", err);
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged(setUser);
                return () => unsubscribe();
            }, []);

            // Real-time Cloud Data Fetching
            useEffect(() => {
                if (!user) return;

                const collectionPath = `artifacts/${appId}/public/data/responses`;
                const unsubscribe = db.collection(collectionPath)
                    .onSnapshot((snapshot) => {
                        const items = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setData(items);
                        setLoading(false);
                        if (window.lucide) window.lucide.createIcons();
                    }, (error) => {
                        console.error("Firestore error:", error);
                        showToast("Failed to load data", "error");
                        setLoading(false);
                    });

                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [data, activeCategory, showForm, toast, isAdmin, loading]);

            const categoryData = useMemo(() => {
                const rawCats = ["All", ...new Set(data.map(i => i.category))];
                return rawCats.map((name, index) => ({
                    name,
                    theme: THEMES[index % THEMES.length]
                }));
            }, [data]);

            const toggleAdmin = () => {
                if (isAdmin) {
                    setIsAdmin(false);
                    showToast("Logged out of Admin Mode", "info");
                } else {
                    const pw = prompt("Enter Admin Password:");
                    if (pw === "ALM989$100%") {
                        setIsAdmin(true);
                        showToast("Admin Mode Activated", "success");
                    } else if (pw !== null) {
                        showToast("Invalid password", "error");
                    }
                }
            };

            const handleFileUpload = async (e) => {
                if (!isAdmin || !user) return;
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();

                reader.onload = async (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const collectionRef = db.collection(`artifacts/${appId}/public/data/responses`);
                        
                        let importCount = 0;
                        for (const sheetName of wb.SheetNames) {
                            const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                            for (const row of jsonData) {
                                const keys = Object.keys(row);
                                const scenario = String(row[keys.find(k => k.toLowerCase().includes('scenario'))] || keys[0] || "Untitled");
                                const message = String(row[keys.find(k => k.toLowerCase().includes('message'))] || "");
                                const section = String(row[keys.find(k => k.toLowerCase().includes('section'))] || "");
                                
                                if (message) {
                                    await collectionRef.add({
                                        scenario,
                                        message,
                                        section,
                                        category: sheetName,
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    importCount++;
                                }
                            }
                        }
                        showToast(`Imported ${importCount} items to cloud`, "success");
                    } catch (err) { 
                        console.error(err);
                        showToast("Import failed", "error"); 
                    }
                };
                reader.readAsBinaryString(file);
            };

            const handleFormSubmit = async (e) => {
                e.preventDefault();
                if (!isAdmin || !user) return;
                
                const collectionRef = db.collection(`artifacts/${appId}/public/data/responses`);
                
                try {
                    if (editingId) {
                        await collectionRef.doc(editingId).update({
                            ...formEntry,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showToast("Response updated online", "success");
                    } else {
                        await collectionRef.add({
                            ...formEntry,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showToast("Response added to cloud", "success");
                    }
                    resetForm();
                } catch (err) {
                    showToast("Save failed", "error");
                }
            };

            const resetForm = () => {
                setFormEntry({ scenario: "", message: "", category: "", section: "" });
                setEditingId(null);
                setShowForm(false);
            };

            const startEdit = (item, e) => {
                e.stopPropagation();
                if (!isAdmin) return;
                setEditingId(item.id);
                setFormEntry({ 
                    scenario: item.scenario, 
                    message: item.message, 
                    category: item.category, 
                    section: item.section 
                });
                setShowForm(true);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const deleteEntry = async (id, e) => {
                e.stopPropagation();
                if (!isAdmin || !user) return;
                if (confirm("Permanently delete this from the cloud?")) {
                    try {
                        await db.doc(`artifacts/${appId}/public/data/responses/${id}`).delete();
                        showToast("Deleted from cloud", "success");
                    } catch (err) {
                        showToast("Delete failed", "error");
                    }
                }
            };

            const handleCopy = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    showToast("Copied!", "success");
                });
            };

            const showToast = (msg, type = "success") => {
                setToast({ show: true, message: msg, type });
                setTimeout(() => setToast({ show: false, message: "" }), 2000);
            };

            const filteredData = data.filter(item => {
                const matchSearch = item.scenario.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                    item.message.toLowerCase().includes(searchTerm.toLowerCase());
                const matchCat = activeCategory === "All" || item.category === activeCategory;
                return matchSearch && matchCat;
            });

            return (
                <div className="min-h-screen pb-12 flex flex-col">
                    <header className="fixed top-0 left-0 right-0 z-40 glass-panel border-b border-slate-200/50">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-slate-900 text-white p-2 rounded-xl shadow-lg">
                                    <i data-lucide="layout-grid" className="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h1 className="font-bold text-slate-800 text-lg leading-none">Response Hub</h1>
                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-0.5 flex items-center gap-1">
                                        <span className={`w-1.5 h-1.5 rounded-full ${user ? 'bg-emerald-400' : 'bg-slate-300'}`}></span>
                                        {isAdmin ? "Admin (Online)" : "Agent View (Cloud)" }
                                    </p>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-2">
                                {isAdmin ? (
                                    <>
                                        <button onClick={() => fileInputRef.current.click()} className="p-2.5 text-slate-500 hover:bg-slate-100 rounded-xl transition-all" title="Cloud Import"><i data-lucide="upload" className="w-5 h-5"></i></button>
                                        <button onClick={() => { resetForm(); setShowForm(!showForm); }} className="flex items-center gap-2 bg-slate-900 text-white px-4 py-2.5 rounded-xl font-bold text-sm shadow-md transition-all active:scale-95">
                                            <i data-lucide={showForm ? "x" : "plus"} className="w-4 h-4"></i>
                                            <span>{showForm ? "Close" : "New"}</span>
                                        </button>
                                        <button onClick={toggleAdmin} className="p-2.5 text-emerald-600 bg-emerald-50 rounded-xl border border-emerald-100" title="Exit Admin"><i data-lucide="unlock" className="w-5 h-5"></i></button>
                                    </>
                                ) : (
                                    <button onClick={toggleAdmin} className="p-2.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-xl transition-all flex items-center gap-2 text-xs font-bold uppercase tracking-wider">
                                        <i data-lucide="lock" className="w-4 h-4"></i>
                                        <span className="hidden sm:inline">Admin Login</span>
                                    </button>
                                )}
                                <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 pt-24 pb-8 w-full flex-grow space-y-8">
                        <div className="space-y-6">
                            <div className="flex flex-wrap gap-2">
                                {categoryData.map(cat => (
                                    <button key={cat.name} onClick={() => setActiveCategory(cat.name)} className={`px-4 py-2 rounded-full text-xs font-bold transition-all border ${activeCategory === cat.name ? `${cat.theme.bg} ${cat.theme.text} ${cat.theme.border}` : 'bg-white text-slate-400 border-slate-100 hover:border-slate-300'}`}>
                                        {cat.name}
                                    </button>
                                ))}
                            </div>
                            <div className="relative group">
                                <i data-lucide="search" className="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                                <input type="text" className="w-full pl-14 pr-6 py-4 rounded-2xl border border-slate-200 outline-none focus:ring-4 focus:ring-slate-50 transition-all text-lg font-medium" placeholder="Search global responses..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                            </div>
                        </div>

                        {showForm && isAdmin && (
                            <div className="bg-white border border-slate-200 rounded-3xl p-6 shadow-xl animate-fade-in">
                                <form onSubmit={handleFormSubmit} className="space-y-4">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <input className="w-full p-3 bg-slate-50 rounded-xl text-sm border border-slate-100 focus:bg-white outline-none" placeholder="Category" value={formEntry.category} onChange={e => setFormEntry({...formEntry, category: e.target.value})} required />
                                        <input className="w-full p-3 bg-slate-50 rounded-xl text-sm border border-slate-100 focus:bg-white outline-none" placeholder="Section" value={formEntry.section} onChange={e => setFormEntry({...formEntry, section: e.target.value})} />
                                        <input className="w-full p-3 bg-slate-50 rounded-xl text-sm border border-slate-100 focus:bg-white outline-none" placeholder="Scenario Title" value={formEntry.scenario} onChange={e => setFormEntry({...formEntry, scenario: e.target.value})} required />
                                    </div>
                                    <textarea className="w-full p-3 bg-slate-50 rounded-xl text-sm border border-slate-100 focus:bg-white outline-none min-h-[150px]" placeholder="Response content..." value={formEntry.message} onChange={e => setFormEntry({...formEntry, message: e.target.value})} required />
                                    <div className="flex justify-end gap-2">
                                        <button type="button" onClick={resetForm} className="px-6 py-2 text-slate-400 font-bold">Cancel</button>
                                        <button type="submit" className="px-6 py-2 bg-slate-900 text-white rounded-xl font-bold shadow-lg flex items-center gap-2">
                                            <i data-lucide="save" className="w-4 h-4"></i>
                                            Save to Cloud
                                        </button>
                                    </div>
                                </form>
                            </div>
                        )}

                        {loading ? (
                            <div className="py-20 text-center space-y-4">
                                <div className="w-12 h-12 border-4 border-slate-200 border-t-slate-900 rounded-full animate-spin mx-auto"></div>
                                <p className="text-slate-400 font-bold text-sm uppercase tracking-widest">Fetching Cloud Library...</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {filteredData.map(item => {
                                    const theme = (categoryData.find(c => c.name === item.category) || {theme: THEMES[0]}).theme;
                                    return (
                                        <div key={item.id} onClick={() => handleCopy(item.message)} className="group bg-white rounded-2xl p-6 cursor-pointer border border-slate-100 shadow-card hover:shadow-xl transition-all relative flex flex-col h-full overflow-hidden">
                                            <div className={`absolute left-0 top-0 bottom-0 w-1 ${theme.text.replace('text-', 'bg-')}`}></div>
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex flex-wrap gap-1">
                                                    <span className={`px-2 py-0.5 rounded text-[10px] font-black uppercase ${theme.bg} ${theme.text}`}>{item.category}</span>
                                                    {item.section && <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100 text-slate-400 uppercase">{item.section}</span>}
                                                </div>
                                                {isAdmin && (
                                                    <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button onClick={(e) => startEdit(item, e)} className="p-1.5 hover:bg-slate-100 rounded text-slate-400"><i data-lucide="edit-3" className="w-3.5 h-3.5"></i></button>
                                                        <button onClick={(e) => deleteEntry(item.id, e)} className="p-1.5 hover:bg-rose-50 rounded text-rose-400"><i data-lucide="trash-2" className="w-3.5 h-3.5"></i></button>
                                                    </div>
                                                )}
                                            </div>
                                            <h3 className="font-bold text-slate-800 mb-2 leading-tight">{item.scenario}</h3>
                                            <p className="text-slate-500 text-sm flex-grow line-clamp-5 leading-relaxed">{item.message}</p>
                                            <div className="mt-4 pt-4 border-t border-slate-50 flex justify-between items-center text-[10px] font-black tracking-widest text-slate-300 uppercase">
                                                <span>Click to copy</span>
                                                <i data-lucide="copy" className="w-3 h-3"></i>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                        
                        {!loading && filteredData.length === 0 && (
                            <div className="py-20 text-center">
                                <p className="text-slate-400 font-medium italic">No cloud responses found matching your search.</p>
                            </div>
                        )}
                    </main>

                    <footer className="mt-auto py-10 text-center border-t border-slate-100">
                        <div className="flex items-center justify-center gap-2 text-slate-400 font-medium text-sm">
                            <span>Created by Ali Abo Ali</span>
                            <i data-lucide="heart" className="w-3.5 h-3.5 text-rose-400 fill-current"></i>
                        </div>
                    </footer>

                    {toast.show && (
                        <div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-50 bg-slate-900 text-white px-6 py-3.5 rounded-2xl shadow-2xl flex items-center gap-3 animate-fade-in">
                            <i data-lucide={toast.type === "error" ? "x-circle" : "check"} className={`w-4 h-4 ${toast.type === "error" ? "text-rose-400" : "text-emerald-400"}`}></i>
                            <span className="text-xs font-bold uppercase tracking-widest">{toast.message}</span>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
